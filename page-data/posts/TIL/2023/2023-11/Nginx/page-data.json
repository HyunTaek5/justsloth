{"componentChunkName":"component---src-template-post-tsx","path":"/posts/TIL/2023/2023-11/Nginx","result":{"data":{"allMarkdownRemark":{"nodes":[{"fields":{"slug":"/posts/book/review/오픈-비즈니스패권의-열쇠/"},"timeToRead":1,"frontmatter":{"title":"오픈 비즈니스 패권의 열쇠","series":"책 리뷰"}},{"fields":{"slug":"/posts/book/review/비전공자도-배울-수-있는-타입스크립트/"},"timeToRead":1,"frontmatter":{"title":"비전공자도 배울 수 있는 타입스크립트","series":"책 리뷰"}},{"fields":{"slug":"/posts/book/review/테라폼으로-시작하는-IaC/"},"timeToRead":1,"frontmatter":{"title":"테라폼으로 시작하는 IaC","series":"책 리뷰"}},{"fields":{"slug":"/posts/book/review/코드-밖-커뮤니케이션/"},"timeToRead":1,"frontmatter":{"title":"코드 밖 커뮤니케이션","series":"책 리뷰"}},{"fields":{"slug":"/posts/book/review/NGINX-쿡북/"},"timeToRead":1,"frontmatter":{"title":"NGINX 쿡북","series":"책 리뷰"}},{"fields":{"slug":"/posts/book/review/처음-시작하는-FastAPI/"},"timeToRead":1,"frontmatter":{"title":"처음 시작하는 FastAPI","series":"책 리뷰"}},{"fields":{"slug":"/posts/book/review/업무에-활용하는-nodejs/"},"timeToRead":1,"frontmatter":{"title":"업무에 활용하는 Node.js","series":"책 리뷰"}},{"fields":{"slug":"/posts/book/review/한권으로-배우는-도커&쿠버네티스/"},"timeToRead":1,"frontmatter":{"title":"한 권으로 배우는 도커 & 쿠버네티스","series":"책 리뷰"}},{"fields":{"slug":"/posts/book/review/도시를-만드는-기술-이야기/"},"timeToRead":1,"frontmatter":{"title":"도시를 만드는 기술 이야기","series":"책 리뷰"}},{"fields":{"slug":"/posts/book/가상-면접-사례-솔루션/1장/"},"timeToRead":1,"frontmatter":{"title":"사용자 수에 따른 규모 확장성","series":"가상 면접 사례로 배우는 대규모 시스템 설계 기초"}},{"fields":{"slug":"/posts/book/review/게임AI를-위한-탐색-알고리즘/"},"timeToRead":1,"frontmatter":{"title":"게임 AI를 위한 탐색 알고리즘","series":"책 리뷰"}},{"fields":{"slug":"/posts/블로그-이관/"},"timeToRead":1,"frontmatter":{"title":"블로그 이관","series":null}},{"fields":{"slug":"/posts/블로그-글-시작하기/"},"timeToRead":1,"frontmatter":{"title":"기술 블로그 글 시작하기","series":"글 잘 쓰기"}},{"fields":{"slug":"/posts/TIL/2023/2023-12/프로젝트-회고/"},"timeToRead":1,"frontmatter":{"title":"2023 사내 프로젝트 회고","series":"배포 회고"}},{"fields":{"slug":"/posts/TIL/2023/2023-12/나무늘보-프롬프트/"},"timeToRead":1,"frontmatter":{"title":"GPT-4 나무늘보 프롬프트","series":"프롬프트"}},{"fields":{"slug":"/posts/TIL/2023/2023-12/채팅-리서치/"},"timeToRead":1,"frontmatter":{"title":"채팅 구현 관련 서비스 리서치","series":"리서치 기록"}},{"fields":{"slug":"/posts/TIL/2023/2023-12/NestJs/Request-LifeCycle/"},"timeToRead":1,"frontmatter":{"title":"NestJs - Request LifeCycle","series":"NestJs"}},{"fields":{"slug":"/posts/TIL/2023/2023-12/NestJs/LifeCycle/"},"timeToRead":1,"frontmatter":{"title":"NestJs - LifeCycle","series":"NestJs"}},{"fields":{"slug":"/posts/TIL/2023/2023-12/DirtyChecking/"},"timeToRead":1,"frontmatter":{"title":"더티 체킹","series":null}},{"fields":{"slug":"/posts/TIL/2023/2023-11/NestJs/Pipes/"},"timeToRead":1,"frontmatter":{"title":"NestJs - Pipes","series":"NestJs 개념 정리"}},{"fields":{"slug":"/posts/TIL/2023/2023-11/Nginx/"},"timeToRead":1,"frontmatter":{"title":"Docker-compose, Nginx와 함께하는 무중단 배포","series":"배포 회고"}},{"fields":{"slug":"/posts/TIL/2023/2023-11/NestJs/MetaData/"},"timeToRead":1,"frontmatter":{"title":"NestJs - MetaData","series":"NestJs 개념 정리"}},{"fields":{"slug":"/posts/TIL/2023/2023-11/AWS - EBS용량관리/"},"timeToRead":1,"frontmatter":{"title":"AWS - EBS 용량 관리","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-11/NestJs/DynamicModule/"},"timeToRead":1,"frontmatter":{"title":"NestJs - Dynamic Module","series":"NestJs 개념 정리"}},{"fields":{"slug":"/posts/TIL/2023/2023-10/OpenTelemetry/메트릭/"},"timeToRead":1,"frontmatter":{"title":"OpenTelemetry  - 메트릭","series":"TIL"}},{"fields":{"slug":"/posts/사이드프로젝트-배포-회고/"},"timeToRead":2,"frontmatter":{"title":"사이드 프로젝트 배포 회고","series":"배포 회고"}},{"fields":{"slug":"/posts/TIL/2023/2023-10/OpenTelemetry/시그널-분산추적/"},"timeToRead":1,"frontmatter":{"title":"OpenTelemetry 시그널 - 분산 추적","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-10/OpenTelemetry/컨텍스트-전파/"},"timeToRead":1,"frontmatter":{"title":"OpenTelemetry - 컨텍스트 전파","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-10/OpenTelemetry/파이프라인-리소스/"},"timeToRead":1,"frontmatter":{"title":"OpenTelemetry - 파이프라인, 리소스","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-10/OpenTelemetry/"},"timeToRead":1,"frontmatter":{"title":"OpenTelemetry","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-10/제3자-결제-애플/"},"timeToRead":3,"frontmatter":{"title":"관찰 가능성 엔지니어링 & 제 3자 결제 - 애플","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-10/제3자-결제-구글/"},"timeToRead":1,"frontmatter":{"title":"제 3자 결제 - 구글","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-10/PortOne-웹훅/"},"timeToRead":1,"frontmatter":{"title":"PortOne - 웹훅","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-10/PortOne-인증결제/"},"timeToRead":1,"frontmatter":{"title":"PortOne - 인증결제","series":"TIL"}},{"fields":{"slug":"/posts/book/대용량-DB-솔루션/1장/"},"timeToRead":1,"frontmatter":{"title":"대용량 DB 솔루션 1장 정리","series":"대용량 DB 솔루션"}},{"fields":{"slug":"/posts/TIL/2023/2023-09/PortOne/"},"timeToRead":1,"frontmatter":{"title":"PortOne - 비인증결제 정리","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-09/인앱-결제/환불/"},"timeToRead":1,"frontmatter":{"title":"인앱 결제 환불 정리","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-09/인앱-결제/"},"timeToRead":1,"frontmatter":{"title":"인앱 결제 정리","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-09/SRE/"},"timeToRead":1,"frontmatter":{"title":"SRE (Site Reliability Engineering) 개념","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-09/SQL-INTERSECT/"},"timeToRead":1,"frontmatter":{"title":"SQL - INTERSECT","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-09/SQL-UNION-ALL/"},"timeToRead":1,"frontmatter":{"title":"SQL - UNION / UNION ALL","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-09/MongoDB-local-참가-후기/"},"timeToRead":1,"frontmatter":{"title":"MongoDB.local Seoul 짧은 참가 후기","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-09/OLTP VS OLAP/"},"timeToRead":1,"frontmatter":{"title":"OLTP vs OLAP","series":"TIL"}},{"fields":{"slug":"/posts/TIL/2023/2023-09/TypeORM-Upsert-중복제거/"},"timeToRead":1,"frontmatter":{"title":"TypeORM orIgnore 메소드 Upsert시 중복 데이터 INSERT 검증 방식 변경","series":"TIL"}}],"group":[{"fieldValue":"NestJs","totalCount":2},{"fieldValue":"NestJs 개념 정리","totalCount":3},{"fieldValue":"TIL","totalCount":19},{"fieldValue":"가상 면접 사례로 배우는 대규모 시스템 설계 기초","totalCount":1},{"fieldValue":"글 잘 쓰기","totalCount":1},{"fieldValue":"대용량 DB 솔루션","totalCount":1},{"fieldValue":"리서치 기록","totalCount":1},{"fieldValue":"배포 회고","totalCount":3},{"fieldValue":"책 리뷰","totalCount":10},{"fieldValue":"프롬프트","totalCount":1}]},"markdownRemark":{"id":"48d504e4-3df4-54c5-aa4a-d1aff51d5797","html":"<p>Github Action 기반 지속가능한 무중단 배포 자동화</p>\n<h2>개요</h2>\n<p>사내에서 MVP 프로젝트 배포시 api 서버의 경우, <code>EC2</code> 인스턴스에 레포를 pull 받고 빌드하여 <code>pm2</code>와 <code>Nginx</code>를 인스턴스 환경에 직접 설치하여 <code>pm2</code>로 api 프로세스를 실행시켜 무중단 상태를 유지시키며 배포하는 방식을 사용하고 있었다.</p>\n<p>기존 배포 방식의 api 서버 내부 프로세스 모식도이다.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.578125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACLElEQVR42n1TTW8TMRDN/+TKH+AKN5C4VoILEmcEgitIwDkonCpVoopUqaS0gv1ee+21vfbu+jHjpZCWwEQvGc+Mx+95nJXWGsaYg7DGQmqJk+wEuv9PnbXoug7jOGIVQsAhi/Rhy2yGoy9HKF15I37bhmEA91rVdY22bQ9CtAJZleEiv0Be5Wl9u6ZpmvRbVdXSkDtPcUacZ2ilEnVmMU0TgvdpQ5xpTfmZIIRIMmOkGEnkGPssO0nmr6gtcQ6wzqKnYgSKKbM0kDIdNgsFUOOO1iNJzF+/wPmzJzi7vMK33W4hwAwnSsqnryAePYfDDBM8wskZ8jv3MbYdJA0j0gHF3YewHz9DxwneB4QiQ8i+ozIevaM17wvMkOROWY1xu4P1w8KQNgzHW0xuSAzZ/OlXzHkDZQ0mqjuXFtuihrg8htItifrFkCVfG98NP6NrY8l84fvGd+x5oiRf9BZzIAJxJNZ+uUOeTlM3hBplWSYIyRPmCdbI8zwNpkl1Sw3vkTQc9rOS4uQXRbEwPPQOdRvQtBJ/cvEGQ+tc8h+83+De2zW9kpheRGpouwahl/B7UCUxyn/AyBrBqFTo+478DqLMUnxQDT5sNni3/oSBehjZLA09JbzRBPUbo9M0kB7B0d+qLdCuX8J3JbylmNUJAx0wpzryeT/lYxiwisHh8H9vkcnMrt48Rhz0X/L313Ho6f06amgEIp0SnTqIySrUNJT5H/kEOiz2NTB6/AQV1jIvICYVwAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"architecture-old\"\n        title=\"\"\n        src=\"/static/24de6937389ce6766efc652026c4e7f9/2bef9/architecture-old.png\"\n        srcset=\"/static/24de6937389ce6766efc652026c4e7f9/6f3f2/architecture-old.png 256w,\n/static/24de6937389ce6766efc652026c4e7f9/01e7c/architecture-old.png 512w,\n/static/24de6937389ce6766efc652026c4e7f9/2bef9/architecture-old.png 1024w,\n/static/24de6937389ce6766efc652026c4e7f9/1e2b7/architecture-old.png 1483w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3>문제점</h3>\n<p>기존 배포 방식에서도 <code>Github Action</code>을 사용해서 CI/CD를 <code>SSH</code>로 대상 <code>EC2</code> 인스턴스에 접근하여 배포 스크립트를 실행시키는 방식으로 구현했었다. 하지만 해당 방식의 경우, 간혹 <code>EC2</code> 인스턴스의 메모리 부족 문제로 인해 pull 이후 빌드 단계에서 인스턴스가 멈춰버리는 이슈가 있어 무중단 자동 배포의 안정성이 떨어지는 단점이 있었다. 기존 배포 자동화 방식이 서버 배포시 안정성이 떨어지는 문제를 해결하고자 Docker 컨테이너 기반 배포 방식으로의 변경을 고려하게 되었다.</p>\n<h2>Github-Action 흐름도</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.578125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABY0lEQVR42q1TTU+DQBDtX/NfePcXeTJqYmLU1pucvPWqMZoevHgoiBQKbAOFlvKxwPI6S0ttWmti6yQvE2D2MW/ebAv/HK31h6qqakDiEMKiKMDzfPVSVAtIcvmtgRACZVnWyKleUBY83Sa8ub3D2fkFHMeB/qnBYgH6niQUSJJ0iQSGYcD3fUTTCbISCPs92KfHAI8aiQvCB0VBu9MB5zkhQzSL4QQpCuogS1OUOa+zqqowTRNhECCl2gmzoHXvQQU/z3B9lsx14RKyLIMfRUg4h+95CMOwli+7zykHUbIteWUGhTyg6zqsoY3hYIAPy8HRpYKuai7nu2lYtdtlGbKjMUmaTBdzGbIRlOc3fNnuqvtNNb8SypAuxnH8/RMyRDr85z1s5LwaNq5e3jGj1SiKHC5j0DStXpW9CK+fejhpP2JMsku5o2TIXh02I/ZGDMy26hU66Ort9u5AwmaNqj3u9Bykk0Ra/3CETwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"github-action-flow-chart\"\n        title=\"\"\n        src=\"/static/a2607ab0077fbc09d2734f2056b5733b/2bef9/github-action-flow-chart.png\"\n        srcset=\"/static/a2607ab0077fbc09d2734f2056b5733b/6f3f2/github-action-flow-chart.png 256w,\n/static/a2607ab0077fbc09d2734f2056b5733b/01e7c/github-action-flow-chart.png 512w,\n/static/a2607ab0077fbc09d2734f2056b5733b/2bef9/github-action-flow-chart.png 1024w,\n/static/a2607ab0077fbc09d2734f2056b5733b/1e2b7/github-action-flow-chart.png 1483w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ol>\n<li>Github 레포에 PR이 머지되면 GithubAction 트리거에 걸려 GithubAction이 실행되고, actions/Checkout을 통해 해당 레포를 Clone한다.</li>\n<li>Github 레포에 미리 세팅해둔 Secrets를 사용하여 Docker Hub에 로그인한다.</li>\n<li>Github Action에서 <code>{프로젝트명}-api/{현재 빌드 시각 timestamp}</code>를 태그로 <code>no-cache</code> 옵션을 포함하여 Docker Image를 빌드한다.</li>\n<li>3단계에서 빌드가 완료된 이미지를 2단계에서 로그인해두었던 DockerHub에 Push한다.</li>\n<li>AWS EC2에 <code>scp</code> 로 배포 관련 설정 파일들을 전송한다.</li>\n<li>AWS EC2에 <code>ssh</code>로 접근하여 새로운 이미지가 포함된 <code>docker-compose.yml</code>을 실행시킨다.\n<ol>\n<li><code>docker-compose.yml</code>에는 <code>Nginx</code>, <code>api</code> 총 2개의 컨테이너가 존재한다.</li>\n</ol>\n</li>\n<li>기존에 떠있던 api 컨테이너를 종료하지 않은 채 새로 Push 되어있는 이미지를 DockerHub에서 Pull 받아 신규 api 컨테이너를 <code>api-2</code> 와 같은 명칭으로 가동시킨 후, <code>롤링</code> 방식으로 <code>v1</code>/<code>v2</code>를  전환하며 별 이슈가 없을 시, 기존 api 컨테이너를 내리고 Nginx 컨테이너 설정을 reload하여 신규 배포된 api 컨테이너로 라우팅되도록 변경사항을 적용한다.</li>\n</ol>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n</style>","fields":{"slug":"/posts/TIL/2023/2023-11/Nginx/"},"timeToRead":1,"frontmatter":{"title":"Docker-compose, Nginx와 함께하는 무중단 배포","tags":["NGINX"],"date":"2023-11-16T15:23:12.000Z","image":null,"series":"배포 회고"}}},"pageContext":{"id":"48d504e4-3df4-54c5-aa4a-d1aff51d5797"}},"staticQueryHashes":["3810308631","4253518612"],"slicesMap":{}}